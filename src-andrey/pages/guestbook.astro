---
import BaseLayout from '../layouts/BaseLayout.astro';
---
<BaseLayout title="Guestbook (D1 + Turnstile)">
  <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6" role="alert">
    <div class="flex">
      <div class="flex-shrink-0">
        <svg class="h-5 w-5 text-yellow-400" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
        </svg>
      </div>
      <div class="ml-3">
        <p class="text-sm">
          <strong>Game Required:</strong> You must achieve at least 100 points in any game to sign the guestbook.
          <a href="/demo" class="underline hover:no-underline">Play games here</a>
        </p>
      </div>
    </div>
  </div>

  <form id="gb" class="space-y-2 mb-6">
    <input name="name" placeholder="Name (optional)" class="border px-2 py-1 w-full" />
    <textarea name="message" placeholder="Message" class="border px-2 py-1 w-full" required></textarea>
    <div id="cf-turnstile" class="cf-turnstile" data-sitekey="YOUR_TURNSTILE_SITE_KEY"></div>
    <button class="bg-black text-white px-3 py-1" type="submit">Sign</button>
  </form>

  <div id="feedback" class="mb-4 hidden"></div>

  <ul id="entries" class="space-y-3 text-sm"></ul>

  <script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>
  <script>
    async function load(){
      const r = await fetch('/guestbook');
      const data = await r.json();
      const list = document.getElementById('entries');
      list.innerHTML = data.map(e => `<li><strong>${e.name}</strong> â€” ${e.message}</li>`).join('');
    }

    function showFeedback(message, type = 'error') {
      const feedback = document.getElementById('feedback');
      feedback.className = `mb-4 p-3 rounded ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
      feedback.textContent = message;
      feedback.classList.remove('hidden');
      setTimeout(() => feedback.classList.add('hidden'), 5000);
    }

    document.getElementById('gb').addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const form = ev.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;

      submitBtn.textContent = 'Submitting...';
      submitBtn.disabled = true;

      try {
        const body = {
          name: form.name.value,
          message: form.message.value,
          turnstileToken: window.turnstile?.getResponse?.()
        };

        const r = await fetch('/guestbook', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify(body)
        });

        const responseData = await r.json();

        if (r.ok) {
          form.reset();
          window.turnstile.reset();
          load();
          showFeedback('Entry added successfully!', 'success');
        } else {
          if (responseData.error === 'Game score requirement not met') {
            showFeedback(responseData.reason || 'You need to play games to unlock guestbook access!');
          } else {
            showFeedback(responseData.error || 'Error submitting entry');
          }
        }
      } catch (error) {
        showFeedback('Network error. Please try again.');
      } finally {
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    });

    load();
  </script>
</BaseLayout>
